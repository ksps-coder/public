<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë°å‰∫ãÊõÜÂÖ±Á∑®Á≥ªÁµ±</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .section-title {
            font-size: 18px;
            color: #555;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #45a049;
        }
        
        .btn-secondary {
            background-color: #008CBA;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #007399;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #da190b;
        }
        
        .btn-warning {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e68900;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: bold;
        }
        
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .input-group input[type="date"] {
            cursor: pointer;
        }
        
        .voice-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .voice-input-wrapper input,
        .voice-input-wrapper textarea {
            flex: 1;
            padding-right: 45px;
        }
        
        .voice-btn {
            position: absolute;
            right: 5px;
            background-color: #666;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
        }
        
        .voice-btn:hover {
            background-color: #555;
        }
        
        .voice-btn.recording {
            background-color: #f44336;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: top;
        }
        
        .preview-table th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        
        .preview-table td {
            background-color: white;
        }
        
        .preview-table .week-col {
            width: 60px;
            text-align: center;
        }
        
        .preview-table .date-col {
            width: 120px;
            white-space: pre-line;
        }
        
        .preview-table .activity-col {
            white-space: pre-line;
        }
        
        .preview-table .note-col {
            white-space: pre-line;
            width: 200px;
        }
        
        .loaded-activity {
            color: #d32f2f;
        }
        
        .new-activity {
            color: #1976d2;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        .activity-actions {
            display: inline-block;
            margin-left: 10px;
        }
        
        .activity-actions button {
            padding: 2px 6px;
            font-size: 12px;
            margin: 0 2px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .edit-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        
        .preview-content {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            white-space: pre-line;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .warning-text {
            color: #ff9800;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }
        
        .file-input-wrapper {
            display: inline-block;
            position: relative;
            overflow: hidden;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: #008CBA;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-label:hover {
            background-color: #007399;
        }
        
        #loadingSpinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Ë°å‰∫ãÊõÜÂÖ±Á∑®Á≥ªÁµ±</h1>
        
        <!-- ËºâÂÖ•ÂÖ±Á∑®Ë°å‰∫ãÊõÜ -->
        <div class="section">
            <button class="btn btn-primary" onclick="loadSharedCalendar()">
                üì• ËºâÂÖ•ÂÖ±Á∑®Ë°å‰∫ãÊõÜ
            </button>
        </div>
        
        <!-- ExcelÊ™îÊ°àËôïÁêÜ -->
        <div class="section">
            <div class="section-title">üìä ExcelÊ™îÊ°àËôïÁêÜ</div>
            <div>
                <div class="file-input-wrapper">
                    <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
                    <label for="excelFile" class="file-input-label">üì§ ‰∏äÂÇ≥EXCELÊ™îÊ°à</label>
                </div>
                <button class="btn btn-secondary" onclick="downloadTemplate()">
                    üìÑ ‰∏ãËºâÁ©∫ÁôΩÁØÑÊú¨
                </button>
                <button class="btn btn-secondary" onclick="downloadSharedData()">
                    üíæ ‰∏ãËºâÂÖ±Á∑®Ë≥áÊñôExcel
                </button>
            </div>
        </div>
        
        <!-- Êñ∞Â¢ûÊ¥ªÂãï -->
        <div class="section">
            <div class="section-title">‚ûï Êñ∞Â¢ûÊ¥ªÂãï</div>
            <div class="input-group">
                <label>ÈñãÂßãÊó•Êúü *</label>
                <input type="date" id="startDate" onchange="syncEndDate()">
            </div>
            <div class="input-group">
                <label>ÁµêÊùüÊó•Êúü</label>
                <input type="date" id="endDate">
            </div>
            <div class="input-group">
                <label>Ê¥ªÂãïÂÖßÂÆπ *</label>
                <div class="voice-input-wrapper">
                    <input type="text" id="activityContent" placeholder="Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂÖßÂÆπ">
                    <button class="voice-btn" onclick="toggleVoiceInput('activityContent')">üé§</button>
                </div>
            </div>
            <div class="input-group">
                <label>ÂÇôË®ª</label>
                <div class="voice-input-wrapper">
                    <textarea id="activityNote" rows="3" placeholder="Ë´ãËº∏ÂÖ•ÂÇôË®ª"></textarea>
                    <button class="voice-btn" onclick="toggleVoiceInput('activityNote')">üé§</button>
                </div>
            </div>
            <button class="btn btn-warning" onclick="addActivity()">
                ‚ú® Êñ∞Â¢ûÊ¥ªÂãï
            </button>
        </div>
        
        <!-- Ë°å‰∫ãÊõÜÈ†êË¶Ω -->
        <div class="section">
            <div class="section-title">üëÅÔ∏è Ë°å‰∫ãÊõÜÈ†êË¶Ω</div>
            <div id="loadingSpinner">
                <div class="spinner"></div>
                <p>ËºâÂÖ•‰∏≠...</p>
            </div>
            <table class="preview-table" id="previewTable">
                <thead>
                    <tr>
                        <th class="week-col">ÈÄ±Ê¨°</th>
                        <th class="date-col">Êó•ÊúüÂçÄÈñì</th>
                        <th class="activity-col">Ê¥ªÂãïÂÖßÂÆπ</th>
                        <th class="note-col">ÂÇôË®ª</th>
                    </tr>
                </thead>
                <tbody id="previewBody">
                    <!-- ÂãïÊÖãÁîüÊàêÂÖßÂÆπ -->
                </tbody>
            </table>
        </div>
        
        <!-- Êñ∞Â¢û‰∏äÂÇ≥Google Sheets -->
        <div class="section">
            <button class="btn btn-primary" onclick="uploadNewToSheets()">
                ‚òÅÔ∏è Êñ∞Â¢û‰∏äÂÇ≥Google Sheets
            </button>
        </div>
        
        <!-- Âº∑Âà∂Ë¶ÜÂØ´Google Sheets -->
        <div class="section">
            <div class="section-title">‚ö†Ô∏è Âº∑Âà∂Ë¶ÜÂØ´Google Sheets</div>
            <div class="input-group">
                <label>Êó•ÊúüÈÅ∏Êìá</label>
                <input type="date" id="overwriteDate" onchange="loadWeekPreview()">
            </div>
            <div class="input-group">
                <label>‰øÆÊîπÈÄ±Ê¨°È†êË¶Ω</label>
                <div class="preview-content" id="weekPreview">
                    Ë´ãÈÅ∏ÊìáÊó•Êúü‰ª•ËºâÂÖ•Ë©≤ÈÄ±Ë≥áÊñô
                </div>
            </div>
            <div class="input-group">
                <label>‰øÆÊîπÊ¥ªÂãïÂÖßÂÆπ</label>
                <textarea id="overwriteActivity" rows="5"></textarea>
                <p class="warning-text">Ë´ãÊâãÂãïË¶ÜÂØ´Ë¶ÅÂÆåÂÖ®ÊåâÁÖßÊéíÂ∫è‰ª•ÂèäÊó•ÊúüÁöÑË¶èÂâá‰æÜÂØ´ÂÖ•ÔºåÊâç‰∏çÊúÉÈÄ†ÊàêÂæåÂè∞google sheetÁöÑÈåØË™§</p>
            </div>
            <div class="input-group">
                <label>‰øÆÊîπÂÇôË®ª</label>
                <textarea id="overwriteNote" rows="5"></textarea>
            </div>
            <button class="btn btn-danger" onclick="overwriteToSheets()">
                ‚ö° Ë¶ÜÂØ´‰∏äÂÇ≥Google Sheets
            </button>
        </div>
        
        <!-- ÂåØÂá∫Ëá≥GoogleË°å‰∫ãÊõÜ -->
        <div class="section">
            <button class="btn btn-warning" onclick="exportToGoogleCalendar()">
                üìÜ ÂåØÂá∫Ëá≥GoogleË°å‰∫ãÊõÜ
            </button>
        </div>
    </div>
    
    <!-- Á∑®ËºØÊ¥ªÂãïModal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Á∑®ËºØÊ¥ªÂãï</h2>
                <span class="close-btn" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="input-group">
                <label>ÈñãÂßãÊó•Êúü</label>
                <input type="date" id="editStartDate">
            </div>
            <div class="input-group">
                <label>ÁµêÊùüÊó•Êúü</label>
                <input type="date" id="editEndDate">
            </div>
            <div class="input-group">
                <label>Ê¥ªÂãïÂÖßÂÆπ</label>
                <input type="text" id="editActivityContent">
            </div>
            <div class="input-group">
                <label>ÂÇôË®ª</label>
                <textarea id="editActivityNote" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveEditedActivity()">ÂÑ≤Â≠ò‰øÆÊîπ</button>
            <button class="btn btn-secondary" onclick="closeEditModal()">ÂèñÊ∂à</button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // GAS Á∂≤ÂùÄË®≠ÂÆöÔºàË´ãÂú®Ê≠§ËôïÂ°´ÂÖ•ÊÇ®ÁöÑ Web App URLÔºâ
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyiCAKl0oGIXGZ1FxrwXZyroRQNToPZSOwQNREaWWsOtc1NMzQKhDhvQ-rKsiyPRcpy/exec';
        
        // Ë°å‰∫ãÊõÜË®≠ÂÆö
        const CALENDAR_START = '2025-08-27';
        const CALENDAR_END = '2026-07-31';
        
        // ÂÖ®ÂüüËÆäÊï∏
        let calendarData = {};
        let loadedData = {};
        let currentEditingActivity = null;
        
        // Ë™ûÈü≥Ë≠òÂà•Áõ∏Èóú
        let recognition = null;
        let currentVoiceInput = null;
        
        // ÂàùÂßãÂåñ
        window.onload = function() {
            initializeCalendar();
            initializeVoiceRecognition();
        };
        
        // ÂàùÂßãÂåñË°å‰∫ãÊõÜÁµêÊßã
        function initializeCalendar() {
            const startDate = new Date(CALENDAR_START);
            const endDate = new Date(CALENDAR_END);
            
            // Ë®àÁÆóÈ†êÂÇôÈÄ±ÁöÑÈñãÂßãÊó•ÊúüÔºàÈñãÂßãÊó•ÊúüÊâÄÂú®ÈÄ±ÁöÑÈÄ±Êó•Ôºâ
            const prepWeekStart = new Date(startDate);
            prepWeekStart.setDate(startDate.getDate() - startDate.getDay());
            
            // ÂàùÂßãÂåñÈ†êÂÇôÈÄ±
            calendarData[0] = {
                weekNum: 0,
                dateRange: `~ ${formatDate(new Date(startDate.getTime() - 86400000))}`,
                activities: [],
                notes: []
            };
            
            // ÂàùÂßãÂåñÊ≠£ÂºèÈÄ±Ê¨°
            let weekNum = 1;
            let currentWeekStart = new Date(prepWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            
            while (currentWeekStart <= endDate) {
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                calendarData[weekNum] = {
                    weekNum: weekNum,
                    dateRange: `${formatDate(currentWeekStart)}~\n${formatDate(weekEnd)}`,
                    activities: [],
                    notes: []
                };
                
                weekNum++;
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            }
            
            renderCalendarPreview();
        }
        
        // ÂàùÂßãÂåñË™ûÈü≥Ë≠òÂà•
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'zh-TW';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    if (currentVoiceInput) {
                        const input = document.getElementById(currentVoiceInput);
                        input.value += transcript;
                    }
                };
                
                recognition.onend = function() {
                    document.querySelectorAll('.voice-btn').forEach(btn => {
                        btn.classList.remove('recording');
                        btn.textContent = 'üé§';
                    });
                };
            }
        }
        
        // ÂàáÊèõË™ûÈü≥Ëº∏ÂÖ•
        function toggleVoiceInput(inputId) {
            if (!recognition) {
                alert('ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëº∏ÂÖ•ÂäüËÉΩ');
                return;
            }
            
            const btn = event.target;
            
            if (btn.classList.contains('recording')) {
                recognition.stop();
                btn.classList.remove('recording');
                btn.textContent = 'üé§';
            } else {
                currentVoiceInput = inputId;
                recognition.start();
                btn.classList.add('recording');
                btn.textContent = 'üî¥';
            }
        }
        
        // ÂêåÊ≠•ÁµêÊùüÊó•Êúü
        function syncEndDate() {
            const startDate = document.getElementById('startDate').value;
            if (startDate) {
                document.getElementById('endDate').value = startDate;
            }
        }
        
        // Êñ∞Â¢ûÊ¥ªÂãï
        function addActivity() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value || startDate;
            const content = document.getElementById('activityContent').value.trim();
            const note = document.getElementById('activityNote').value.trim();
            
            if (!startDate || !content) {
                alert('Ë´ãÂ°´ÂØ´ÈñãÂßãÊó•ÊúüÂíåÊ¥ªÂãïÂÖßÂÆπÔºÅ');
                return;
            }
            
            // Âª∫Á´ãÊ¥ªÂãïÁâ©‰ª∂
            const activity = {
                startDate: startDate,
                endDate: endDate,
                title: content,
                note: note,
                isNew: true
            };
            
            // Âä†ÂÖ•Âà∞Â∞çÊáâÈÄ±Ê¨°
            addActivityToWeek(activity);
            
            // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê¨Ñ‰Ωç
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('activityContent').value = '';
            document.getElementById('activityNote').value = '';
            
            // ÈáçÊñ∞Ê∏≤Êüì
            renderCalendarPreview();
        }
        
        // Â∞áÊ¥ªÂãïÂä†ÂÖ•Â∞çÊáâÈÄ±Ê¨°
        function addActivityToWeek(activity) {
            const activityDate = new Date(activity.startDate);
            const calendarStart = new Date(CALENDAR_START);
            
            // Â¶ÇÊûúÂú®ÈñãÂßãÊó•Êúü‰πãÂâçÔºåÂä†ÂÖ•È†êÂÇôÈÄ±
            if (activityDate < calendarStart) {
                const displayText = formatActivityDisplay(activity);
                calendarData[0].activities.push({
                    ...activity,
                    displayText: displayText
                });
                if (activity.note) {
                    calendarData[0].notes.push(activity.note);
                }
                return;
            }
            
            // ÊâæÂá∫Â∞çÊáâÈÄ±Ê¨°
            for (let weekNum in calendarData) {
                if (weekNum === '0') continue;
                
                const weekData = calendarData[weekNum];
                const [weekStart, weekEnd] = parseWeekRange(weekData.dateRange);
                
                if (activityDate >= weekStart && activityDate <= weekEnd) {
                    const displayText = formatActivityDisplay(activity);
                    weekData.activities.push({
                        ...activity,
                        displayText: displayText
                    });
                    if (activity.note) {
                        weekData.notes.push(activity.note);
                    }
                    
                    // ÊéíÂ∫èÊ¥ªÂãï
                    sortActivitiesInWeek(weekData);
                    break;
                }
            }
        }
        
        // Ê†ºÂºèÂåñÊ¥ªÂãïÈ°ØÁ§∫ÊñáÂ≠ó
        function formatActivityDisplay(activity) {
            const date = new Date(activity.startDate);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const weekDay = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'][date.getDay()];
            
            return `${month}-${day}(${weekDay}) ${activity.title}`;
        }
        
        // Ëß£ÊûêÈÄ±Ê¨°Êó•ÊúüÁØÑÂúç
        function parseWeekRange(dateRange) {
            const cleanRange = dateRange.replace(/\n/g, '');
            
            // ËôïÁêÜÈ†êÂÇôÈÄ±
            if (cleanRange.startsWith('~')) {
                const endDate = new Date(cleanRange.substring(2));
                const startDate = new Date('1900-01-01');
                return [startDate, endDate];
            }
            
            const [start, end] = cleanRange.split('~');
            return [new Date(start), new Date(end)];
        }
        
        // ÊéíÂ∫èÈÄ±Ê¨°ÂÖßÁöÑÊ¥ªÂãï
        function sortActivitiesInWeek(weekData) {
            weekData.activities.sort((a, b) => {
                return new Date(a.startDate) - new Date(b.startDate);
            });
        }
        
        // Ê∏≤ÊüìË°å‰∫ãÊõÜÈ†êË¶Ω
        function renderCalendarPreview() {
            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = '';
            
            for (let weekNum in calendarData) {
                const weekData = calendarData[weekNum];
                const row = document.createElement('tr');
                
                // ÈÄ±Ê¨°
                const weekCell = document.createElement('td');
                weekCell.className = 'week-col';
                weekCell.textContent = weekData.weekNum;
                row.appendChild(weekCell);
                
                // Êó•ÊúüÂçÄÈñì
                const dateCell = document.createElement('td');
                dateCell.className = 'date-col';
                dateCell.textContent = weekData.dateRange;
                row.appendChild(dateCell);
                
                // Ê¥ªÂãïÂÖßÂÆπ
                const activityCell = document.createElement('td');
                activityCell.className = 'activity-col';
                activityCell.innerHTML = renderActivities(weekData.activities, weekNum);
                row.appendChild(activityCell);
                
                // ÂÇôË®ª
                const noteCell = document.createElement('td');
                noteCell.className = 'note-col';
                noteCell.textContent = weekData.notes.join('\n');
                row.appendChild(noteCell);
                
                tbody.appendChild(row);
            }
        }
        
        // Ê∏≤ÊüìÊ¥ªÂãïÂàóË°®
        function renderActivities(activities, weekNum) {
            return activities.map((activity, index) => {
                const cssClass = activity.isNew ? 'new-activity' : 'loaded-activity';
                const actions = `
                    <span class="activity-actions">
                        <button class="edit-btn" onclick="editActivity(${weekNum}, ${index})">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteActivity(${weekNum}, ${index})">üóëÔ∏è</button>
                    </span>
                `;
                return `<span class="${cssClass}">${activity.displayText}${actions}</span>`;
            }).join('\n');
        }
        
        // Á∑®ËºØÊ¥ªÂãï
        function editActivity(weekNum, activityIndex) {
            const activity = calendarData[weekNum].activities[activityIndex];
            currentEditingActivity = { weekNum, activityIndex };
            
            // Â°´ÂÖ•Á∑®ËºØË°®ÂñÆ
            document.getElementById('editStartDate').value = activity.startDate;
            document.getElementById('editEndDate').value = activity.endDate;
            document.getElementById('editActivityContent').value = activity.title;
            document.getElementById('editActivityNote').value = activity.note || '';
            
            // È°ØÁ§∫ Modal
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Âà™Èô§Ê¥ªÂãï
        function deleteActivity(weekNum, activityIndex) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ê¥ªÂãïÂóéÔºü')) {
                const weekData = calendarData[weekNum];
                const activity = weekData.activities[activityIndex];
                
                // Âà™Èô§Ê¥ªÂãï
                weekData.activities.splice(activityIndex, 1);
                
                // Âà™Èô§Â∞çÊáâÁöÑÂÇôË®ª
                const noteIndex = weekData.notes.findIndex(note => note === activity.note);
                if (noteIndex !== -1) {
                    weekData.notes.splice(noteIndex, 1);
                }
                
                renderCalendarPreview();
            }
        }
        
        // ÂÑ≤Â≠òÁ∑®ËºØÁöÑÊ¥ªÂãï
        function saveEditedActivity() {
            if (!currentEditingActivity) return;
            
            const { weekNum, activityIndex } = currentEditingActivity;
            const oldActivity = calendarData[weekNum].activities[activityIndex];
            
            // ÂèñÂæóÊñ∞Ë≥áÊñô
            const newActivity = {
                startDate: document.getElementById('editStartDate').value,
                endDate: document.getElementById('editEndDate').value,
                title: document.getElementById('editActivityContent').value,
                note: document.getElementById('editActivityNote').value,
                isNew: oldActivity.isNew
            };
            
            // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÁßªÂãïÂà∞ÂÖ∂‰ªñÈÄ±Ê¨°
            const newDate = new Date(newActivity.startDate);
            const [weekStart, weekEnd] = parseWeekRange(calendarData[weekNum].dateRange);
            
            if (newDate >= weekStart && newDate <= weekEnd) {
                // ‰ªçÂú®Âêå‰∏ÄÈÄ±ÔºåÁõ¥Êé•Êõ¥Êñ∞
                calendarData[weekNum].activities[activityIndex] = {
                    ...newActivity,
                    displayText: formatActivityDisplay(newActivity)
                };
                
                // Êõ¥Êñ∞ÂÇôË®ª
                const oldNoteIndex = calendarData[weekNum].notes.findIndex(note => note === oldActivity.note);
                if (oldNoteIndex !== -1) {
                    calendarData[weekNum].notes[oldNoteIndex] = newActivity.note;
                } else if (newActivity.note) {
                    calendarData[weekNum].notes.push(newActivity.note);
                }
                
                sortActivitiesInWeek(calendarData[weekNum]);
            } else {
                // ÈúÄË¶ÅÁßªÂãïÂà∞ÂÖ∂‰ªñÈÄ±Ê¨°
                deleteActivity(weekNum, activityIndex);
                addActivityToWeek(newActivity);
            }
            
            closeEditModal();
            renderCalendarPreview();
        }
        
        // ÈóúÈñâÁ∑®ËºØ Modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingActivity = null;
        }
        
        // ËºâÂÖ•ÂÖ±Á∑®Ë°å‰∫ãÊõÜ
        async function loadSharedCalendar() {
            try {
                showLoading(true);
                const response = await fetch(`${GAS_URL}?action=load`);
                const data = await response.json();
                
                if (data.success) {
                    // Ê∏ÖÁ©∫ÁèæÊúâË≥áÊñô
                    initializeCalendar();
                    
                    // ËºâÂÖ•Ë≥áÊñô
                    data.data.forEach(row => {
                        if (row.activities) {
                            const activities = JSON.parse(row.activities);
                            activities.forEach(activity => {
                                addActivityToWeek({
                                    ...activity,
                                    isNew: false
                                });
                            });
                        }
                    });
                    
                    renderCalendarPreview();
                    alert('ËºâÂÖ•ÊàêÂäüÔºÅ');
                } else {
                    alert('ËºâÂÖ•Â§±ÊïóÔºö' + data.error);
                }
            } catch (error) {
                alert('ËºâÂÖ•Â§±ÊïóÔºö' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // ‰∏äÂÇ≥Êñ∞Â¢ûË≥áÊñôÂà∞ Google Sheets
        async function uploadNewToSheets() {
            try {
                showLoading(true);
                
                // Êî∂ÈõÜÊñ∞Â¢ûÁöÑÊ¥ªÂãï
                const dataToUpload = [];
                for (let weekNum in calendarData) {
                    const weekData = calendarData[weekNum];
                    const newActivities = weekData.activities.filter(a => a.isNew);
                    
                    if (newActivities.length > 0) {
                        dataToUpload.push({
                            weekNum: weekData.weekNum,
                            dateRange: weekData.dateRange.replace(/\n/g, '~'),
                            activities: JSON.stringify(newActivities),
                            displayActivities: newActivities.map(a => a.displayText).join('\n'),
                            notes: weekData.notes.join('\n')
                        });
                    }
                }
                
                if (dataToUpload.length === 0) {
                    alert('Ê≤íÊúâÊñ∞Â¢ûÁöÑÊ¥ªÂãïÈúÄË¶Å‰∏äÂÇ≥ÔºÅ');
                    showLoading(false);
                    return;
                }
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'upload',
                        data: dataToUpload
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Êõ¥Êñ∞Ê¥ªÂãïÁãÄÊÖã
                    for (let weekNum in calendarData) {
                        calendarData[weekNum].activities.forEach(activity => {
                            if (activity.isNew) {
                                activity.isNew = false;
                            }
                        });
                    }
                    renderCalendarPreview();
                    alert('‰∏äÂÇ≥ÊàêÂäüÔºÅ');
                } else {
                    alert('‰∏äÂÇ≥Â§±ÊïóÔºö' + result.error);
                }
            } catch (error) {
                alert('‰∏äÂÇ≥Â§±ÊïóÔºö' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // ËºâÂÖ•ÈÄ±Ê¨°È†êË¶Ω
        async function loadWeekPreview() {
            const selectedDate = document.getElementById('overwriteDate').value;
            if (!selectedDate) return;
            
            const date = new Date(selectedDate);
            let targetWeek = null;
            
            // ÊâæÂá∫Â∞çÊáâÈÄ±Ê¨°
            for (let weekNum in calendarData) {
                const weekData = calendarData[weekNum];
                const [weekStart, weekEnd] = parseWeekRange(weekData.dateRange);
                
                if (date >= weekStart && date <= weekEnd) {
                    targetWeek = weekData;
                    break;
                }
            }
            
            if (targetWeek) {
                const preview = document.getElementById('weekPreview');
                const activities = targetWeek.activities.map(a => a.displayText).join('\n');
                const notes = targetWeek.notes.join('\n');
                
                preview.innerHTML = `
                    <strong>ÈÄ±Ê¨° ${targetWeek.weekNum}</strong><br>
                    <strong>Êó•ÊúüÂçÄÈñìÔºö</strong>${targetWeek.dateRange.replace(/\n/g, '~')}<br>
                    <strong>Ê¥ªÂãïÂÖßÂÆπÔºö</strong><br>${activities || '(ÁÑ°Ê¥ªÂãï)'}<br>
                    <strong>ÂÇôË®ªÔºö</strong><br>${notes || '(ÁÑ°ÂÇôË®ª)'}
                `;
                
                // È†êÂ°´‰øÆÊîπÊ¨Ñ‰Ωç
                document.getElementById('overwriteActivity').value = activities;
                document.getElementById('overwriteNote').value = notes;
            }
        }
        
        // Ë¶ÜÂØ´‰∏äÂÇ≥Âà∞ Google Sheets
        async function overwriteToSheets() {
            const selectedDate = document.getElementById('overwriteDate').value;
            if (!selectedDate) {
                alert('Ë´ãÈÅ∏ÊìáÊó•ÊúüÔºÅ');
                return;
            }
            
            if (!confirm('Á¢∫ÂÆöË¶ÅË¶ÜÂØ´Ê≠§ÈÄ±Ê¨°ÁöÑË≥áÊñôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ')) {
                return;
            }
            
            try {
                showLoading(true);
                
                const date = new Date(selectedDate);
                let targetWeekNum = null;
                
                // ÊâæÂá∫Â∞çÊáâÈÄ±Ê¨°
                for (let weekNum in calendarData) {
                    const weekData = calendarData[weekNum];
                    const [weekStart, weekEnd] = parseWeekRange(weekData.dateRange);
                    
                    if (date >= weekStart && date <= weekEnd) {
                        targetWeekNum = weekNum;
                        break;
                    }
                }
                
                if (targetWeekNum === null) {
                    alert('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑÈÄ±Ê¨°ÔºÅ');
                    showLoading(false);
                    return;
                }
                
                const newActivities = document.getElementById('overwriteActivity').value;
                const newNotes = document.getElementById('overwriteNote').value;
                
                // Ëß£ÊûêÊ¥ªÂãïÂÖßÂÆπÁÇ∫ÁµêÊßãÂåñË≥áÊñô
                const parsedActivities = parseActivitiesFromText(newActivities, targetWeekNum);
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'overwrite',
                        weekNum: targetWeekNum,
                        data: {
                            activities: JSON.stringify(parsedActivities),
                            displayActivities: newActivities,
                            notes: newNotes
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Êõ¥Êñ∞Êú¨Âú∞Ë≥áÊñô
                    calendarData[targetWeekNum].activities = parsedActivities.map(a => ({
                        ...a,
                        displayText: formatActivityDisplay(a),
                        isNew: false
                    }));
                    calendarData[targetWeekNum].notes = newNotes ? newNotes.split('\n') : [];
                    
                    renderCalendarPreview();
                    alert('Ë¶ÜÂØ´ÊàêÂäüÔºÅ');
                } else {
                    alert('Ë¶ÜÂØ´Â§±ÊïóÔºö' + result.error);
                }
            } catch (error) {
                alert('Ë¶ÜÂØ´Â§±ÊïóÔºö' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // ÂæûÊñáÂ≠óËß£ÊûêÊ¥ªÂãï
        function parseActivitiesFromText(text, weekNum) {
            if (!text) return [];
            
            const activities = [];
            const lines = text.split('\n');
            const weekData = calendarData[weekNum];
            const [weekStart, weekEnd] = parseWeekRange(weekData.dateRange);
            const year = weekStart.getFullYear();
            
            lines.forEach(line => {
                const match = line.match(/(\d{2})-(\d{2})\([‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠Êó•]\)\s+(.+)/);
                if (match) {
                    const [_, month, day, title] = match;
                    let activityYear = year;
                    
                    // ËôïÁêÜË∑®Âπ¥ÊÉÖÊ≥Å
                    if (parseInt(month) === 1 && weekEnd.getMonth() === 11) {
                        activityYear = year + 1;
                    }
                    
                    activities.push({
                        startDate: `${activityYear}-${month}-${day}`,
                        endDate: `${activityYear}-${month}-${day}`,
                        title: title.trim(),
                        note: ''
                    });
                }
            });
            
            return activities;
        }
        
        // Excel ËôïÁêÜÂäüËÉΩ
        async function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const data = await readExcelFile(file);
                
                data.forEach(row => {
                    if (row.startDate && row.title) {
                        addActivityToWeek({
                            startDate: formatExcelDate(row.startDate),
                            endDate: formatExcelDate(row.endDate || row.startDate),
                            title: row.title,
                            note: row.note || '',
                            isNew: true
                        });
                    }
                });
                
                renderCalendarPreview();
                alert('Excel Ê™îÊ°àÂåØÂÖ•ÊàêÂäüÔºÅ');
            } catch (error) {
                alert('Excel Ê™îÊ°àËÆÄÂèñÂ§±ÊïóÔºö' + error.message);
            }
            
            // Ê∏ÖÁ©∫Ê™îÊ°àÈÅ∏Êìá
            event.target.value = '';
        }
        
        // ËÆÄÂèñ Excel Ê™îÊ°à
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Ê†ºÂºèÂåñ Excel Êó•Êúü
        function formatExcelDate(excelDate) {
            if (!excelDate) return '';
            
            // Â¶ÇÊûúÊòØÊï∏Â≠óÔºàExcel Êó•ÊúüÂ∫èËôüÔºâ
            if (typeof excelDate === 'number') {
                const date = XLSX.SSF.parse_date_code(excelDate);
                return `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
            }
            
            // Â¶ÇÊûúÂ∑≤Á∂ìÊòØÂ≠ó‰∏≤Ê†ºÂºè
            return excelDate;
        }
        
        // ‰∏ãËºâÁ©∫ÁôΩÁØÑÊú¨
        function downloadTemplate() {
            const template = [
                {
                    startDate: '2025-09-01',
                    endDate: '2025-09-01',
                    title: 'ÁØÑ‰æãÊ¥ªÂãï',
                    note: 'ÈÄôÊòØÂÇôË®ª'
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ë°å‰∫ãÊõÜÁØÑÊú¨');
            
            // Ë®≠ÂÆöÊ¨ÑÂØ¨
            ws['!cols'] = [
                { width: 15 }, // startDate
                { width: 15 }, // endDate
                { width: 30 }, // title
                { width: 30 }  // note
            ];
            
            XLSX.writeFile(wb, 'Ë°å‰∫ãÊõÜÁØÑÊú¨.xlsx');
        }
        
        // ‰∏ãËºâÂÖ±Á∑®Ë≥áÊñô
        async function downloadSharedData() {
            try {
                showLoading(true);
                const response = await fetch(`${GAS_URL}?action=download`);
                const data = await response.json();
                
                if (data.success) {
                    const exportData = [];
                    
                    data.data.forEach(row => {
                        if (row.activities) {
                            const activities = JSON.parse(row.activities);
                            activities.forEach(activity => {
                                exportData.push({
                                    ÈÄ±Ê¨°: row.weekNum,
                                    Êó•ÊúüÂçÄÈñì: row.dateRange,
                                    ÈñãÂßãÊó•Êúü: activity.startDate,
                                    ÁµêÊùüÊó•Êúü: activity.endDate,
                                    Ê¥ªÂãïÂÖßÂÆπ: activity.title,
                                    ÂÇôË®ª: activity.note
                                });
                            });
                        }
                    });
                    
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Ë°å‰∫ãÊõÜË≥áÊñô');
                    
                    XLSX.writeFile(wb, `Ë°å‰∫ãÊõÜË≥áÊñô_${formatDate(new Date())}.xlsx`);
                } else {
                    alert('‰∏ãËºâÂ§±ÊïóÔºö' + data.error);
                }
            } catch (error) {
                alert('‰∏ãËºâÂ§±ÊïóÔºö' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // ÂåØÂá∫Ëá≥ Google Ë°å‰∫ãÊõÜ
        async function exportToGoogleCalendar() {
            if (!confirm('Ê≠§ÂäüËÉΩÂ∞áÊâπÊ¨°Âª∫Á´ã Google Ë°å‰∫ãÊõÜÊ¥ªÂãïÔºåÊòØÂê¶ÁπºÁ∫åÔºü')) {
                return;
            }
            
            try {
                showLoading(true);
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'exportToCalendar'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`ÊàêÂäüÂª∫Á´ã ${result.count} ÂÄãË°å‰∫ãÊõÜÊ¥ªÂãïÔºÅ`);
                } else {
                    alert('ÂåØÂá∫Â§±ÊïóÔºö' + result.error);
                }
            } catch (error) {
                alert('ÂåØÂá∫Â§±ÊïóÔºö' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // È°ØÁ§∫/Èö±ËóèËºâÂÖ•‰∏≠
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }
        
        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Modal Â§ñÈÉ®ÈªûÊìäÈóúÈñâ
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        };
    </script>
</body>
</html>
