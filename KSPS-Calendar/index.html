<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œäº‹æ›†å…±ç·¨ç³»çµ±</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .section-title {
            font-size: 18px;
            color: #555;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #45a049;
        }
        
        .btn-secondary {
            background-color: #008CBA;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #007399;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #da190b;
        }
        
        .btn-warning {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e68900;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: bold;
        }
        
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .input-group input[type="date"] {
            cursor: pointer;
        }
        
        .voice-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .voice-input-wrapper input,
        .voice-input-wrapper textarea {
            flex: 1;
            padding-right: 45px;
        }
        
        .voice-btn {
            position: absolute;
            right: 5px;
            background-color: #666;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
        }
        
        .voice-btn:hover {
            background-color: #555;
        }
        
        .voice-btn.recording {
            background-color: #f44336;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: top;
        }
        
        .preview-table th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        
        .preview-table td {
            background-color: white;
        }
        
        .preview-table .week-col {
            width: 60px;
            text-align: center;
        }
        
        .preview-table .date-col {
            width: 120px;
            white-space: pre-line;
        }
        
        .preview-table .activity-col {
            white-space: pre-line;
        }
        
        .preview-table .note-col {
            white-space: pre-line;
            width: 200px;
        }
        
        .loaded-activity {
            color: #d32f2f;
        }
        
        .new-activity {
            color: #1976d2;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        .activity-actions {
            display: inline-block;
            margin-left: 10px;
        }
        
        .activity-actions button {
            padding: 2px 6px;
            font-size: 12px;
            margin: 0 2px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .edit-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        
        .preview-content {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            white-space: pre-line;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .warning-text {
            color: #ff9800;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }
        
        .file-input-wrapper {
            display: inline-block;
            position: relative;
            overflow: hidden;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: #008CBA;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-label:hover {
            background-color: #007399;
        }
        
        #loadingSpinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“… è¡Œäº‹æ›†å…±ç·¨ç³»çµ±</h1>
        
        <!-- è¼‰å…¥å…±ç·¨è¡Œäº‹æ›† -->
        <div class="section">
            <button class="btn btn-primary" onclick="loadSharedCalendar()">
                ğŸ“¥ è¼‰å…¥å…±ç·¨è¡Œäº‹æ›†
            </button>
        </div>
        
        <!-- Excelæª”æ¡ˆè™•ç† -->
        <div class="section">
            <div class="section-title">ğŸ“Š Excelæª”æ¡ˆè™•ç†</div>
            <div>
                <div class="file-input-wrapper">
                    <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
                    <label for="excelFile" class="file-input-label">ğŸ“¤ ä¸Šå‚³EXCELæª”æ¡ˆ</label>
                </div>
                <button class="btn btn-secondary" onclick="downloadTemplate()">
                    ğŸ“„ ä¸‹è¼‰ç©ºç™½ç¯„æœ¬
                </button>
                <button class="btn btn-secondary" onclick="downloadSharedData()">
                    ğŸ’¾ ä¸‹è¼‰å…±ç·¨è³‡æ–™Excel
                </button>
            </div>
        </div>
        
        <!-- æ–°å¢æ´»å‹• -->
        <div class="section">
            <div class="section-title">â• æ–°å¢æ´»å‹•</div>
            <div class="input-group">
                <label>é–‹å§‹æ—¥æœŸ *</label>
                <input type="date" id="startDate" onchange="syncEndDate()">
            </div>
            <div class="input-group">
                <label>çµæŸæ—¥æœŸ</label>
                <input type="date" id="endDate">
            </div>
            <div class="input-group">
                <label>æ´»å‹•å…§å®¹ *</label>
                <div class="voice-input-wrapper">
                    <input type="text" id="activityContent" placeholder="è«‹è¼¸å…¥æ´»å‹•å…§å®¹">
                    <button class="voice-btn" onclick="toggleVoiceInput('activityContent')">ğŸ¤</button>
                </div>
            </div>
            <div class="input-group">
                <label>å‚™è¨»</label>
                <div class="voice-input-wrapper">
                    <textarea id="activityNote" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»"></textarea>
                    <button class="voice-btn" onclick="toggleVoiceInput('activityNote')">ğŸ¤</button>
                </div>
            </div>
            <button class="btn btn-warning" onclick="addActivity()">
                âœ¨ æ–°å¢æ´»å‹•
            </button>
        </div>
        
        <!-- è¡Œäº‹æ›†é è¦½ -->
        <div class="section">
            <div class="section-title">ğŸ‘ï¸ è¡Œäº‹æ›†é è¦½</div>
            <div id="loadingSpinner">
                <div class="spinner"></div>
                <p>è¼‰å…¥ä¸­...</p>
            </div>
            <table class="preview-table" id="previewTable">
                <thead>
                    <tr>
                        <th class="week-col">é€±æ¬¡</th>
                        <th class="date-col">æ—¥æœŸå€é–“</th>
                        <th class="activity-col">æ´»å‹•å…§å®¹</th>
                        <th class="note-col">å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="previewBody">
                    <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                </tbody>
            </table>
        </div>
        
        <!-- æ–°å¢ä¸Šå‚³Google Sheets -->
        <div class="section">
            <button class="btn btn-primary" onclick="uploadNewToSheets()">
                â˜ï¸ æ–°å¢ä¸Šå‚³Google Sheets
            </button>
        </div>
        
        <!-- å¼·åˆ¶è¦†å¯«Google Sheets -->
        <div class="section">
            <div class="section-title">âš ï¸ å¼·åˆ¶è¦†å¯«Google Sheets</div>
            <div class="input-group">
                <label>æ—¥æœŸé¸æ“‡</label>
                <input type="date" id="overwriteDate" onchange="loadWeekPreview()">
            </div>
            <div class="input-group">
                <label>ä¿®æ”¹é€±æ¬¡é è¦½</label>
                <div class="preview-content" id="weekPreview">
                    è«‹é¸æ“‡æ—¥æœŸä»¥è¼‰å…¥è©²é€±è³‡æ–™
                </div>
            </div>
            <div class="input-group">
                <label>ä¿®æ”¹æ´»å‹•å…§å®¹</label>
                <textarea id="overwriteActivity" rows="5"></textarea>
                <p class="warning-text">è«‹æ‰‹å‹•è¦†å¯«è¦å®Œå…¨æŒ‰ç…§æ’åºä»¥åŠæ—¥æœŸçš„è¦å‰‡ä¾†å¯«å…¥ï¼Œæ‰ä¸æœƒé€ æˆå¾Œå°google sheetçš„éŒ¯èª¤</p>
            </div>
            <div class="input-group">
                <label>ä¿®æ”¹å‚™è¨»</label>
                <textarea id="overwriteNote" rows="5"></textarea>
            </div>
            <button class="btn btn-danger" onclick="overwriteToSheets()">
                âš¡ è¦†å¯«ä¸Šå‚³Google Sheets
            </button>
        </div>
        
        <!-- åŒ¯å‡ºè‡³Googleè¡Œäº‹æ›† -->
        <div class="section">
            <button class="btn btn-warning" onclick="exportToGoogleCalendar()">
                ğŸ“† åŒ¯å‡ºè‡³Googleè¡Œäº‹æ›†
            </button>
        </div>
    </div>
    
    <!-- ç·¨è¼¯æ´»å‹•Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç·¨è¼¯æ´»å‹•</h2>
                <span class="close-btn" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="input-group">
                <label>é–‹å§‹æ—¥æœŸ</label>
                <input type="date" id="editStartDate">
            </div>
            <div class="input-group">
                <label>çµæŸæ—¥æœŸ</label>
                <input type="date" id="editEndDate">
            </div>
            <div class="input-group">
                <label>æ´»å‹•å…§å®¹</label>
                <input type="text" id="editActivityContent">
            </div>
            <div class="input-group">
                <label>å‚™è¨»</label>
                <textarea id="editActivityNote" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveEditedActivity()">å„²å­˜ä¿®æ”¹</button>
            <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // GAS ç¶²å€è¨­å®šï¼ˆè«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Web App URLï¼‰
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyiCAKl0oGIXGZ1FxrwXZyroRQNToPZSOwQNREaWWsOtc1NMzQKhDhvQ-rKsiyPRcpy/exec';
        
        // è¡Œäº‹æ›†è¨­å®š
        const CALENDAR_START = '2025-08-27';
        const CALENDAR_END = '2026-07-31';
        
        // å…¨åŸŸè®Šæ•¸
        let calendarData = {};
        let loadedData = {};
        let currentEditingActivity = null;
        
        // èªéŸ³è­˜åˆ¥ç›¸é—œ
        let recognition = null;
        let currentVoiceInput = null;
        
        // åˆå§‹åŒ–
        window.onload = function() {
            initializeCalendar();
            initializeVoiceRecognition();
        };
        
        // åˆå§‹åŒ–è¡Œäº‹æ›†çµæ§‹
        function initializeCalendar() {
            const startDate = new Date(CALENDAR_START);
            const endDate = new Date(CALENDAR_END);
            
            // è¨ˆç®—é å‚™é€±çš„é–‹å§‹æ—¥æœŸï¼ˆé–‹å§‹æ—¥æœŸæ‰€åœ¨é€±çš„é€±æ—¥ï¼‰
            const prepWeekStart = new Date(startDate);
            prepWeekStart.setDate(startDate.getDate() - startDate.getDay());
            
            // åˆå§‹åŒ–é å‚™é€±
            calendarData[0] = {
                weekNum: 0,
                dateRange: `~ ${formatDate(new Date(startDate.getTime() - 86400000))}`,
                activities: [],
                notes: []
            };
            
            // åˆå§‹åŒ–æ­£å¼é€±æ¬¡
            let weekNum = 1;
            let currentWeekStart = new Date(prepWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            
            while (currentWeekStart <= endDate) {
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                calendarData[weekNum] = {
                    weekNum: weekNum,
                    dateRange: `${formatDate(currentWeekStart)}~\n${formatDate(weekEnd)}`,
                    activities: [],
                    notes: []
                };
                
                weekNum++;
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            }
            
            renderCalendarPreview();
        }
        
        // åˆå§‹åŒ–èªéŸ³è­˜åˆ¥
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'zh-TW';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    if (currentVoiceInput) {
                        const input = document.getElementById(currentVoiceInput);
                        input.value += transcript;
                    }
                };
                
                recognition.onend = function() {
                    document.querySelectorAll('.voice-btn').forEach(btn => {
                        btn.classList.remove('recording');
                        btn.textContent = 'ğŸ¤';
                    });
                };
            }
        }
        
        // åˆ‡æ›èªéŸ³è¼¸å…¥
        function toggleVoiceInput(inputId) {
            if (!recognition) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½');
                return;
            }
            
            const btn = event.target;
            
            if (btn.classList.contains('recording')) {
                recognition.stop();
                btn.classList.remove('recording');
                btn.textContent = 'ğŸ¤';
            } else {
                currentVoiceInput = inputId;
                recognition.start();
                btn.classList.add('recording');
                btn.textContent = 'ğŸ”´';
            }
        }
        
        // åŒæ­¥çµæŸæ—¥æœŸ
        function syncEndDate() {
            const startDate = document.getElementById('startDate').value;
            if (startDate) {
                document.getElementById('endDate').value = startDate;
            }
        }
        
        // æ–°å¢æ´»å‹•
        function addActivity() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value || startDate;
            const content = document.getElementById('activityContent').value.trim();
            const note = document.getElementById('activityNote').value.trim();
            
            if (!startDate || !content) {
                alert('è«‹å¡«å¯«é–‹å§‹æ—¥æœŸå’Œæ´»å‹•å…§å®¹ï¼');
                return;
            }
            
            // å»ºç«‹æ´»å‹•ç‰©ä»¶
            const activity = {
                startDate: startDate,
                endDate: endDate,
                title: content,
                note: note,
                isNew: true
            };
            
            // åŠ å…¥åˆ°å°æ‡‰é€±æ¬¡
            addActivityToWeek(activity);
            
            // æ¸…ç©ºè¼¸å…¥æ¬„ä½
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('activityContent').value = '';
            document.getElementById('activityNote').value = '';
            
            // é‡æ–°æ¸²æŸ“
            renderCalendarPreview();
        }
        
        // å°‡æ´»å‹•åŠ å…¥å°æ‡‰é€±æ¬¡
        function addActivityToWeek(activity) {
            const activityDate = new Date(activity.startDate);
            const calendarStart = new Date(CALENDAR_START);
            
            // å¦‚æœåœ¨é–‹å§‹æ—¥æœŸä¹‹å‰ï¼ŒåŠ å…¥é å‚™é€±
            if (activityDate < calendarStart) {
                const displayText = formatActivityDisplay(activity);
                calendarData[0].activities.push({
                    ...activity,
                    displayText: displayText
                });
                if (activity.note) {
                    calendarData[0].notes.push(activity.note);
                }
                return;
            }
            
            // æ‰¾å‡ºå°æ‡‰é€±æ¬¡
            for (let weekNum in calendarData) {
                if (weekNum === '0') continue;
                
                const weekData = calendarData[weekNum];
                const [weekStart, weekEnd] = parseWeekRange(weekData.dateRange);
                
                if (activityDate >= weekStart && activityDate <= weekEnd) {
                    const displayText = formatActivityDisplay(activity);
                    weekData.activities.push({
                        ...activity,
                        displayText: displayText
                    });
                    if (activity.note) {
                        weekData.notes.push(activity.note);
                    }
                    
                    // æ’åºæ´»å‹•
                    sortActivitiesInWeek(weekData);
                    break;
                }
            }
        }
        
        // æ ¼å¼åŒ–æ´»å‹•é¡¯ç¤ºæ–‡å­—
        function formatActivityDisplay(activity) {
            const date = new Date(activity.startDate);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const weekDay = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
            
            return `${month}-${day}(${weekDay}) ${activity.title}`;
        }
        
        // è§£æé€±æ¬¡æ—¥æœŸç¯„åœ
        function parseWeekRange(dateRange) {
            const cleanRange = dateRange.replace(/\n/g, '');
            
            // è™•ç†é å‚™é€±
            if (cleanRange.startsWith('~')) {
                const endDate = new Date(cleanRange.substring(2));
                const startDate = new Date('1900-01-01');
                return [startDate, endDate];
            }
            
            const [start, end] = cleanRange.split('~');
            return [new Date(start), new Date(end)];
        }
        
        // æ’åºé€±æ¬¡å…§çš„æ´»å‹•
        function sortActivitiesInWeek(weekData) {
            weekData.activities.sort((a, b) => {
                return new Date(a.startDate) - new Date(b.startDate);
            });
        }
        
        // æ¸²æŸ“è¡Œäº‹æ›†é è¦½
        function renderCalendarPreview() {
            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = '';
            
            for (let weekNum in calendarData) {
                const weekData = calendarData[weekNum];
                const row = document.createElement('tr');
                
                // é€±æ¬¡
                const weekCell = document.createElement('td');
                weekCell.className = 'week-col';
                weekCell.textContent = weekData.weekNum;
                row.appendChild(weekCell);
                
                // æ—¥æœŸå€é–“
                const dateCell = document.createElement('td');
                dateCell.className = 'date-col';
                dateCell.textContent = weekData.dateRange;
                row.appendChild(dateCell);
                
                // æ´»å‹•å…§å®¹
                const activityCell = document.createElement('td');
                activityCell.className = 'activity-col';
                activityCell.innerHTML = renderActivities(weekData.activities, weekNum);
                row.appendChild(activityCell);
                
                // å‚™è¨»
                const noteCell = document.createElement('td');
                noteCell.className = 'note-col';
                noteCell.textContent = weekData.notes.join('\n');
                row.appendChild(noteCell);
                
                tbody.appendChild(row);
            }
        }
        
        // æ¸²æŸ“æ´»å‹•åˆ—è¡¨
        function renderActivities(activities, weekNum) {
            return activities.map((activity, index) => {
                const cssClass = activity.isNew ? 'new-activity' : 'loaded-activity';
                const actions = `
                    <span class="activity-actions">
                        <button class="edit-btn" onclick="editActivity(${weekNum}, ${index})">âœï¸</button>
                        <button class="delete-btn" onclick="deleteActivity(${weekNum}, ${index})">ğŸ—‘ï¸</button>
                    </span>
                `;
                return `<span class="${cssClass}">${activity.displayText}${actions}</span>`;
            }).join('\n');
        }
        
        // ç·¨è¼¯æ´»å‹•
        function editActivity(weekNum, activityIndex) {
            const activity = calendarData[weekNum].activities[activityIndex];
            currentEditingActivity = { weekNum, activityIndex };
            
            // å¡«å…¥ç·¨è¼¯è¡¨å–®
            document.getElementById('editStartDate').value = activity.startDate;
            document.getElementById('editEndDate').value = activity.endDate;
            document.getElementById('editActivityContent').value = activity.title;
            document.getElementById('editActivityNote').value = activity.note || '';
            
            // é¡¯ç¤º Modal
            document.getElementById('editModal').style.display = 'block';
        }
        
        // åˆªé™¤æ´»å‹•
        function deleteActivity(weekNum, activityIndex) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿ')) {
                const weekData = calendarData[weekNum];
                const activity = weekData.activities[activityIndex];
                
                // åˆªé™¤æ´»å‹•
                weekData.activities.splice(activityIndex, 1);
                
                // åˆªé™¤å°æ‡‰çš„å‚™è¨»
                const noteIndex = weekData.notes.findIndex(note => note === activity.note);
                if (noteIndex !== -1) {
                    weekData.notes.splice(noteIndex, 1);
                }
                
                renderCalendarPreview();
            }
        }
        
        // å„²å­˜ç·¨è¼¯çš„æ´»å‹•
        function saveEditedActivity() {
            if (!currentEditingActivity) return;
            
            const { weekNum, activityIndex } = currentEditingActivity;
            const oldActivity = calendarData[weekNum].activities[activityIndex];
            
            // å–å¾—æ–°è³‡æ–™
            const newActivity = {
                startDate: document.getElementById('editStartDate').value,
                endDate: document.getElementById('editEndDate').value,
                title: document.getElementById('editActivityContent').value,
                note: document.getElementById('editActivityNote').value,
                isNew: oldActivity.isNew
            };
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦ç§»å‹•åˆ°å…¶ä»–é€±æ¬¡
            const newDate = new Date(newActivity.startDate);
            const [weekStart, weekEnd] = parseWeekRange(calendarData[weekNum].dateRange);
            
            if (newDate >= weekStart && newDate <= weekEnd) {
                // ä»åœ¨åŒä¸€é€±ï¼Œç›´æ¥æ›´æ–°
                calendarData[weekNum].activities[activityIndex] = {
                    ...newActivity,
                    displayText: formatActivityDisplay(newActivity)
                };
                
                // æ›´æ–°å‚™è¨»
                const oldNoteIndex = calendarData[weekNum].notes.findIndex(note => note === oldActivity.note);
                if (oldNoteIndex !== -1) {
                    calendarData[weekNum].notes[oldNoteIndex] = newActivity.note;
                } else if (newActivity.note) {
                    calendarData[weekNum].notes.push(newActivity.note);
                }
                
                sortActivitiesInWeek(calendarData[weekNum]);
            } else {
                // éœ€è¦ç§»å‹•åˆ°å…¶ä»–é€±æ¬¡
                deleteActivity(weekNum, activityIndex);
                addActivityToWeek(newActivity);
            }
            
            closeEditModal();
            renderCalendarPreview();
        }
        
        // é—œé–‰ç·¨è¼¯ Modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingActivity = null;
        }
        
        // è¼‰å…¥å…±ç·¨è¡Œäº‹æ›†
        async function loadSharedCalendar() {
            try {
                showLoading(true);
                const response = await fetch(`${GAS_URL}?action=load`);
                const data = await response.json();
                
                if (data.success) {
                    // æ¸…ç©ºç¾æœ‰è³‡æ–™
                    initializeCalendar();
                    
                    // è¼‰å…¥è³‡æ–™
                    data.data.forEach(row => {
                        if (row.activities) {
                            const activities = JSON.parse(row.activities);
                            activities.forEach(activity => {
                                addActivityToWeek({
                                    ...activity,
                                    isNew: false
                                });
                            });
                        }
                    });
                    
                    renderCalendarPreview();
                    alert('è¼‰å…¥æˆåŠŸï¼');
                } else {
                    alert('è¼‰å…¥å¤±æ•—ï¼š' + data.error);
                }
            } catch (error) {
                alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // ä¸Šå‚³æ–°å¢è³‡æ–™åˆ° Google Sheets
        async function uploadNewToSheets() {
            try {
                showLoading(true);
                
                // æ”¶é›†æ–°å¢çš„æ´»å‹•
                const dataToUpload = [];
                for (let weekNum in calendarData) {
                    const weekData = calendarData[weekNum];
                    const newActivities = weekData.activities.filter(a => a.isNew);
                    
                    if (newActivities.length > 0) {
                        dataToUpload.push({
                            weekNum: weekData.weekNum,
                            dateRange: weekData.dateRange.replace(/\n/g, '~'),
                            activities: JSON.stringify(newActivities),
                            displayActivities: newActivities.map(a => a.displayText).join('\n'),
                            notes: weekData.notes.join('\n')
                        });
                    }
                }
                
                if (dataToUpload.length === 0) {
                    alert('æ²’æœ‰æ–°å¢çš„æ´»å‹•éœ€è¦ä¸Šå‚³ï¼');
                    showLoading(false);
                    return;
                }
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'upload',
                        data: dataToUpload
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ›´æ–°æ´»å‹•ç‹€æ…‹
                    for (let weekNum in calendarData) {
                        calendarData[weekNum].activities.forEach(activity => {
                            if (activity.isNew) {
                                activity.isNew = false;
                            }
                        });
                    }
                    renderCalendarPreview();
                    alert('ä¸Šå‚³æˆåŠŸï¼');
                } else {
                    alert('ä¸Šå‚³å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                alert('ä¸Šå‚³å¤±æ•—ï¼š' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // è¼‰å…¥é€±æ¬¡é è¦½
        async function loadWeekPreview() {
            const selectedDate = document.getElementById('overwriteDate').value;
            if (!selectedDate) return;
            
            const date = new Date(selectedDate);
            let targetWeek = null;
            
            // æ‰¾å‡ºå°æ‡‰é€±æ¬¡
            for (let weekNum in calendarData) {
                const weekData = calendarData[weekNum];
                const [weekStart, weekEnd] = parseWeekRange(weekData.dateRange);
                
                if (date >= weekStart && date <= weekEnd) {
                    targetWeek = weekData;
                    break;
                }
            }
            
            if (targetWeek) {
                const preview = document.getElementById('weekPreview');
                const activities = targetWeek.activities.map(a => a.displayText).join('\n');
                const notes = targetWeek.notes.join('\n');
                
                preview.innerHTML = `
                    <strong>é€±æ¬¡ ${targetWeek.weekNum}</strong><br>
                    <strong>æ—¥æœŸå€é–“ï¼š</strong>${targetWeek.dateRange.replace(/\n/g, '~')}<br>
                    <strong>æ´»å‹•å…§å®¹ï¼š</strong><br>${activities || '(ç„¡æ´»å‹•)'}<br>
                    <strong>å‚™è¨»ï¼š</strong><br>${notes || '(ç„¡å‚™è¨»)'}
                `;
                
                // é å¡«ä¿®æ”¹æ¬„ä½
                document.getElementById('overwriteActivity').value = activities;
                document.getElementById('overwriteNote').value = notes;
            }
        }
        
        // è¦†å¯«ä¸Šå‚³åˆ° Google Sheets
        async function overwriteToSheets() {
            const selectedDate = document.getElementById('overwriteDate').value;
            if (!selectedDate) {
                alert('è«‹é¸æ“‡æ—¥æœŸï¼');
                return;
            }
            
            if (!confirm('ç¢ºå®šè¦è¦†å¯«æ­¤é€±æ¬¡çš„è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            try {
                showLoading(true);
                
                const date = new Date(selectedDate);
                let targetWeekNum = null;
                
                // æ‰¾å‡ºå°æ‡‰é€±æ¬¡
                for (let weekNum in calendarData) {
                    const weekData = calendarData[weekNum];
                    const [weekStart, weekEnd] = parseWeekRange(weekData.dateRange);
                    
                    if (date >= weekStart && date <= weekEnd) {
                        targetWeekNum = weekNum;
                        break;
                    }
                }
                
                if (targetWeekNum === null) {
                    alert('æ‰¾ä¸åˆ°å°æ‡‰çš„é€±æ¬¡ï¼');
                    showLoading(false);
                    return;
                }
                
                const newActivities = document.getElementById('overwriteActivity').value;
                const newNotes = document.getElementById('overwriteNote').value;
                
                // è§£ææ´»å‹•å…§å®¹ç‚ºçµæ§‹åŒ–è³‡æ–™
                const parsedActivities = parseActivitiesFromText(newActivities, targetWeekNum);
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'overwrite',
                        weekNum: targetWeekNum,
                        data: {
                            activities: JSON.stringify(parsedActivities),
                            displayActivities: newActivities,
                            notes: newNotes
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ›´æ–°æœ¬åœ°è³‡æ–™
                    calendarData[targetWeekNum].activities = parsedActivities.map(a => ({
                        ...a,
                        displayText: formatActivityDisplay(a),
                        isNew: false
                    }));
                    calendarData[targetWeekNum].notes = newNotes ? newNotes.split('\n') : [];
                    
                    renderCalendarPreview();
                    alert('è¦†å¯«æˆåŠŸï¼');
                } else {
                    alert('è¦†å¯«å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                alert('è¦†å¯«å¤±æ•—ï¼š' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // å¾æ–‡å­—è§£ææ´»å‹•
        function parseActivitiesFromText(text, weekNum) {
            if (!text) return [];
            
            const activities = [];
            const lines = text.split('\n');
            const weekData = calendarData[weekNum];
            const [weekStart, weekEnd] = parseWeekRange(weekData.dateRange);
            const year = weekStart.getFullYear();
            
            lines.forEach(line => {
                const match = line.match(/(\d{2})-(\d{2})\([ä¸€äºŒä¸‰å››äº”å…­æ—¥]\)\s+(.+)/);
                if (match) {
                    const [_, month, day, title] = match;
                    let activityYear = year;
                    
                    // è™•ç†è·¨å¹´æƒ…æ³
                    if (parseInt(month) === 1 && weekEnd.getMonth() === 11) {
                        activityYear = year + 1;
                    }
                    
                    activities.push({
                        startDate: `${activityYear}-${month}-${day}`,
                        endDate: `${activityYear}-${month}-${day}`,
                        title: title.trim(),
                        note: ''
                    });
                }
            });
            
            return activities;
        }
        
        // Excel è™•ç†åŠŸèƒ½
        async function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const data = await readExcelFile(file);
                
                data.forEach(row => {
                    if (row.startDate && row.title) {
                        addActivityToWeek({
                            startDate: formatExcelDate(row.startDate),
                            endDate: formatExcelDate(row.endDate || row.startDate),
                            title: row.title,
                            note: row.note || '',
                            isNew: true
                        });
                    }
                });
                
                renderCalendarPreview();
                alert('Excel æª”æ¡ˆåŒ¯å…¥æˆåŠŸï¼');
            } catch (error) {
                alert('Excel æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
            }
            
            // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
            event.target.value = '';
        }
        
        // è®€å– Excel æª”æ¡ˆ
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // æ ¼å¼åŒ– Excel æ—¥æœŸ
        function formatExcelDate(excelDate) {
            if (!excelDate) return '';
            
            // å¦‚æœæ˜¯æ•¸å­—ï¼ˆExcel æ—¥æœŸåºè™Ÿï¼‰
            if (typeof excelDate === 'number') {
                const date = XLSX.SSF.parse_date_code(excelDate);
                return `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
            }
            
            // å¦‚æœå·²ç¶“æ˜¯å­—ä¸²æ ¼å¼
            return excelDate;
        }
        
        // ä¸‹è¼‰ç©ºç™½ç¯„æœ¬
        function downloadTemplate() {
            const template = [
                {
                    startDate: '2025-09-01',
                    endDate: '2025-09-01',
                    title: 'ç¯„ä¾‹æ´»å‹•',
                    note: 'é€™æ˜¯å‚™è¨»'
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è¡Œäº‹æ›†ç¯„æœ¬');
            
            // è¨­å®šæ¬„å¯¬
            ws['!cols'] = [
                { width: 15 }, // startDate
                { width: 15 }, // endDate
                { width: 30 }, // title
                { width: 30 }  // note
            ];
            
            XLSX.writeFile(wb, 'è¡Œäº‹æ›†ç¯„æœ¬.xlsx');
        }
        
        // ä¸‹è¼‰å…±ç·¨è³‡æ–™
        async function downloadSharedData() {
            try {
                showLoading(true);
                const response = await fetch(`${GAS_URL}?action=download`);
                const data = await response.json();
                
                if (data.success) {
                    const exportData = [];
                    
                    data.data.forEach(row => {
                        if (row.activities) {
                            const activities = JSON.parse(row.activities);
                            activities.forEach(activity => {
                                exportData.push({
                                    é€±æ¬¡: row.weekNum,
                                    æ—¥æœŸå€é–“: row.dateRange,
                                    é–‹å§‹æ—¥æœŸ: activity.startDate,
                                    çµæŸæ—¥æœŸ: activity.endDate,
                                    æ´»å‹•å…§å®¹: activity.title,
                                    å‚™è¨»: activity.note
                                });
                            });
                        }
                    });
                    
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'è¡Œäº‹æ›†è³‡æ–™');
                    
                    XLSX.writeFile(wb, `è¡Œäº‹æ›†è³‡æ–™_${formatDate(new Date())}.xlsx`);
                } else {
                    alert('ä¸‹è¼‰å¤±æ•—ï¼š' + data.error);
                }
            } catch (error) {
                alert('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // åŒ¯å‡ºè‡³ Google è¡Œäº‹æ›†
        async function exportToGoogleCalendar() {
            if (!confirm('æ­¤åŠŸèƒ½å°‡æ‰¹æ¬¡å»ºç«‹ Google è¡Œäº‹æ›†æ´»å‹•ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ')) {
                return;
            }
            
            try {
                showLoading(true);
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'exportToCalendar'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`æˆåŠŸå»ºç«‹ ${result.count} å€‹è¡Œäº‹æ›†æ´»å‹•ï¼`);
                } else {
                    alert('åŒ¯å‡ºå¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                alert('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // é¡¯ç¤º/éš±è—è¼‰å…¥ä¸­
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Modal å¤–éƒ¨é»æ“Šé—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        };
    </script>
</body>
</html>
